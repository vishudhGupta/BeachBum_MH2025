{% comment %}
  Shop the Look – slider with image hotspots
  - Uses global component-slider.css (scroll-snap)
  - Blocks:
      * look (one slide) – desktop & mobile image
      * pin  (a hotspot) – choose which slide (look #), XY position %, product
  - Desktop: product card on right updates when pin clicked
  - Mobile: product opens in popup
{% endcomment %}

<section class="stl-wrap color-{{ section.settings.color_scheme }} gradient">
      {% if section.settings.heading != blank or section.settings.subheading != blank %}
    <div class="stl-heading page-width">
      {% if section.settings.heading != blank %}
        <h2 class="stl-heading__title">{{ section.settings.heading }}</h2>
      {% endif %}
      {% if section.settings.subheading != blank %}
        <p class="stl-heading__sub">{{ section.settings.subheading }}</p>
      {% endif %}
    </div>
  {% endif %}

  <slider-component class="{% unless section.settings.full_width %}page-width{% endunless %}">
    <div id="STL-Track-{{ section.id }}" class="slider slider--everywhere stl-track" role="list" aria-label="Shop the Look">
      {%- assign look_index = 0 -%}
      {%- for block in section.blocks -%}
        {%- if block.type == 'look' -%}
          {%- assign look_index = look_index | plus: 1 -%}
          {%- assign desktop_img = block.settings.desktop_image -%}
          {%- assign mobile_img  = block.settings.mobile_image | default: desktop_img -%}

          <div class="slider__slide stl-slide" role="group" aria-roledescription="slide" aria-label="{{ look_index }}" data-look="{{ look_index }}" tabindex="-1" {{ block.shopify_attributes }}>
            <div class="stl-grid">
              <!-- Left: image with pins -->
              <div class="stl-media">
                <picture>
                  {%- if mobile_img != blank -%}
                    <source media="(max-width: 749px)"
                      srcset="{{ mobile_img | image_url: width: 1500 }} 1500w, {{ mobile_img | image_url: width: 1100 }} 1100w, {{ mobile_img | image_url: width: 750 }} 750w"
                      sizes="100vw">
                  {%- endif -%}
                  {%- if desktop_img != blank -%}
                    {{ desktop_img | image_url: width: 2800 | image_tag: loading: 'lazy', sizes: '100vw', widths: '1100, 1500, 2000, 2400, 2800', alt: block.settings.alt_text | escape }}
                  {%- else -%}
                    {{ 'hero-apparel-1' | placeholder_svg_tag: 'placeholder-svg' }}
                  {%- endif -%}
                </picture>

                {%- comment -%} Pins for this look {%- endcomment -%}
                {%- for p in section.blocks -%}
                  {%- if p.type == 'pin' and p.settings.look_ref == look_index and p.settings.product != blank -%}
                    {%- assign prod = p.settings.product -%}
                    <button
                      class="stl-pin"
                      style="--x: {{ p.settings.pos_x }}%; --y: {{ p.settings.pos_y }}%;"
                      type="button"
                      aria-label="{{ prod.title | escape }}"
                      data-pin-id="pin-{{ p.id }}"
                      data-look="{{ look_index }}"
                      data-product-handle="{{ prod.handle }}"
                      data-product-title="{{ prod.title | escape }}"
                      data-product-url="{{ prod.url }}"
                      data-product-price="{{ prod.price | money }}"
                      data-product-image="{{ prod.featured_image | image_url: width: 700 }}"
                    >
                      <span></span>
                    </button>

                    {%- comment -%} Hidden card template for this pin (used on desktop panel & mobile modal) {%- endcomment -%}
                    <template id="tpl-{{ p.id }}">
                      <div class="stl-card">
                        <div class="stl-card__image">
                          {%- if prod.featured_image -%}
                            <img src="{{ prod.featured_image | image_url: width: 700 }}" alt="{{ prod.title | escape }}" width="350" height="350" loading="lazy">
                          {%- endif -%}
                        </div>
                        <div class="stl-card__body">
                          {%- if prod.vendor != blank -%}
                            <div class="stl-card__vendor">{{ prod.vendor }}</div>
                          {%- endif -%}
                          <h3 class="stl-card__title"><a href="{{ prod.url }}">{{ prod.title }}</a></h3>
                          <div class="stl-card__price">{{ prod.price | money }}</div>
                          <a class="stl-btn" href="{{ prod.url }}">View product</a>
                        </div>
                      </div>
                    </template>
                  {%- endif -%}
                {%- endfor -%}
              </div>

              <!-- Right: product panel (desktop) -->
              <div class="stl-panel">
                <div class="stl-panel__inner">
                  {%- comment -%}
                    Render the first pin's product by default for this look
                  {%- endcomment -%}
                  {%- assign first_pin = nil -%}
                  {%- for p in section.blocks -%}
                    {%- if p.type == 'pin' and p.settings.look_ref == look_index and p.settings.product != blank -%}
                      {%- assign first_pin = p -%}
                      {%- break -%}
                    {%- endif -%}
                  {%- endfor -%}

                  {%- if first_pin -%}
                    {%- assign prod = first_pin.settings.product -%}
                    <div class="stl-card" data-panel-for="{{ look_index }}">
                      <div class="stl-card__image">
                        {%- if prod.featured_image -%}
                          <img src="{{ prod.featured_image | image_url: width: 700 }}" alt="{{ prod.title | escape }}" width="350" height="350" loading="lazy">
                        {%- endif -%}
                      </div>
                      <div class="stl-card__body">
                        {%- if prod.vendor != blank -%}
                          <div class="stl-card__vendor">{{ prod.vendor }}</div>
                        {%- endif -%}
                        <h3 class="stl-card__title"><a href="{{ prod.url }}">{{ prod.title }}</a></h3>
                        <div class="stl-card__price">{{ prod.price | money }}</div>
                        <a class="stl-btn" href="{{ prod.url }}">View product</a>
                      </div>
                    </div>
                  {%- else -%}
                    <div class="stl-panel__placeholder">Add a product pin to this look</div>
                  {%- endif -%}

                  {%- comment -%} Pagination dots for pins (below card) {%- endcomment -%}
                  <div class="stl-pin-dots" aria-hidden="true">
                    {%- for p in section.blocks -%}
                      {%- if p.type == 'pin' and p.settings.look_ref == look_index and p.settings.product != blank -%}
                        <span class="stl-pin-dot" data-pin-linked="pin-{{ p.id }}"></span>
                      {%- endif -%}
                    {%- endfor -%}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>

    {%- if look_index > 1 -%}
      <div class="slider-buttons">
        <button type="button" class="slider-button slider-button--prev" aria-label="Previous look" aria-controls="STL-Track-{{ section.id }}">
          <span class="svg-wrapper">{{ 'icon-caret.svg' | inline_asset_content }}</span>
        </button>
        <button type="button" class="slider-button slider-button--next" aria-label="Next look" aria-controls="STL-Track-{{ section.id }}">
          <span class="svg-wrapper">{{ 'icon-caret.svg' | inline_asset_content }}</span>
        </button>
      </div>
    {%- endif -%}
  </slider-component>

  <!-- Mobile Modal -->
 <!-- Mobile Popup (bottom sheet style) -->
<div class="stl-modal" id="stl-modal-{{ section.id }}" hidden>
  <div class="stl-modal__backdrop" data-close></div>
  <div class="stl-modal__dialog">
    <div class="stl-modal__header">
      <h3>Shop The Look</h3>
      <button class="stl-modal__close" data-close>&times;</button>
    </div>
    <div class="stl-modal__content"></div>
  </div>
</div>


  <style>
    /* Layout */
    .stl-track{ display:flex; flex-wrap:nowrap; overflow-x:auto; scroll-snap-type:x mandatory; scroll-behavior:smooth; overscroll-behavior-x:contain; }
    .stl-slide{ flex:0 0 100%; width:100%; scroll-snap-align:start; }
    .stl-grid{ display:grid; gap:40px; align-items:center; grid-template-columns:1.4fr 1fr; }
    @media (max-width: 989px){ .stl-grid{ grid-template-columns:1fr; gap:20px; } }

    .stl-media{ position:relative; }
    .stl-media picture, .stl-media img{ display:block; width:100%; height:auto; border-radius:6px; }

    /* Pins */
    .stl-pin{ position:absolute; left:var(--x); top:var(--y); transform:translate(-50%, -50%); width:26px; height:26px; border-radius:50%; border:none; background:transparent; cursor:pointer; }
    .stl-pin span{ position:absolute; inset:0; border-radius:50%; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.25); }
    .stl-pin::after{ content:""; position:absolute; inset:-8px; border-radius:50%; border:2px solid rgba(255,255,255,.6); }

    /* Right panel */
    .stl-panel__inner{ max-width:540px; margin-inline:auto; }
    .stl-card{ display:grid; grid-template-columns:160px 1fr; gap:16px; align-items:start; }
    .stl-card__image img{ width:100%; height:auto; display:block; border-radius:6px; }
    .stl-card__vendor{ font-size:12px; opacity:.7; margin-bottom:6px; letter-spacing:.08em; text-transform:uppercase; }
    .stl-card__title{ font-size:18px; margin:0 0 6px; }
    .stl-card__title a{ color:inherit; text-decoration:none; }
    .stl-card__price{ margin:8px 0 14px; font-weight:600; }
    .stl-btn{ display:inline-block; padding:10px 18px; border:1px solid currentColor; border-radius:3px; text-decoration:none; }
    .stl-panel__placeholder{ opacity:.6; }

    .stl-pin-dots{ display:flex; gap:8px; margin-top:16px; justify-content:center; }
    .stl-pin-dot{ width:6px; height:6px; border-radius:999px; background:rgba(0,0,0,.3); }
    .stl-pin-dot.is-active{ background:rgba(0,0,0,.9); }

    /* Mobile modal */
    @media (max-width: 989px){
      .stl-panel{ display:none; } /* hide desktop panel on mobile */
    }
   /* ===== SHOP THE LOOK MOBILE POPUP (BOTTOM SHEET STYLE) ===== */
@media (max-width: 989px) {
  .stl-modal[hidden]{ display:none; }

  .stl-modal {
    position: fixed;
    inset: 0;
    z-index: 999;
  }

  .stl-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.5);
    transition: opacity 0.3s ease;
  }

  .stl-modal__dialog {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    background: #fff;
    border-radius: 16px 16px 0 0;
    box-shadow: 0 -4px 25px rgba(0,0,0,0.25);
    transform: translateY(100%);
    transition: transform 0.35s ease-out;
    max-height: 85vh;
    overflow-y: auto;
    padding-bottom: 20px;
  }

  .stl-modal.is-active .stl-modal__dialog {
    transform: translateY(0%);
  }

  .stl-modal__header {
    display: flex;
    justify-content: center;
    align-items: center;
    position: sticky;
    top: 0;
    background: #fff;
    border-bottom: 1px solid #eee;
    padding: 14px 16px;
    z-index: 2;
  }

  .stl-modal__header h3 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .stl-modal__close {
    position: absolute;
    right: 16px;
    top: 12px;
    font-size: 20px;
    border: none;
    background: none;
    cursor: pointer;
    opacity: 0.8;
  }

  .stl-modal__content {
    padding: 16px;
    text-align: center;
  }

  .stl-modal__content .stl-card__image {
    width: 100%;
    max-width: 280px;
    margin: 0 auto 16px;
  }

  .stl-modal__content .stl-card__title {
    font-size: 16px;
    margin-bottom: 8px;
  }

  .stl-modal__content .stl-card__price {
    margin-bottom: 8px;
    font-weight: 600;
  }

  .stl-modal__content .stl-btn {
    margin-top: 16px;
    width: 100%;
    border-radius: 4px;
  }

  /* optional: fake rating stars placeholder */
  .stl-rating {
    font-size: 13px;
    color: #f5b50a;
    margin: 6px 0;
  }
}

    /* ====== SIZE + LAYOUT TUNING TO MATCH REFERENCE ====== */

/* Two fixed columns like the mock: big look image + product panel */
.stl-grid{
  /* gap ~80 on large, ~40 around tablet */
  column-gap: clamp(40px, 6vw, 80px);
  align-items: start;
  /* large left, smaller right – but explicit maxes to keep proportions */
  grid-template-columns:
    minmax(680px, 820px)    /* left image max width */
    minmax(420px, 560px);   /* right card panel max width */
}

/* Left media should not stretch past max, keeps portrait feeling */
.stl-media{
  max-width: 820px;
}
.stl-media img{
  width: 100%;
  height: auto;
  display: block;
  border-radius: 6px;
  /* helps keep a tall feel if original is very wide */
  object-fit: cover;
}

/* Right panel width + internal centering */
.stl-panel__inner{
  width: min(560px, 38vw);
  margin-inline: auto;
}

/* Product card stacks vertically (image over text), centered */
.stl-card{
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
}

/* Square product image around 520px, centered */
.stl-card__image{
  width: min(520px, 34vw);
}
.stl-card__image img{
  width: 100%;
  height: auto;
  display: block;
  border-radius: 6px;
  /* if you want a perfect square crop, uncomment: */
  /* aspect-ratio: 1 / 1; object-fit: cover; */
}

/* Typography spacing to mirror reference */
.stl-card__vendor{
  font-size: 12px;
  letter-spacing: .12em;
  text-transform: uppercase;
  opacity: .7;
  margin-top: 6px;
  text-align: center;
}
.stl-card__title{
  margin: 0;
  font-size: 16px;
  letter-spacing: .04em;
  text-align: center;
}
.stl-card__price{
  margin: 10px 0 16px;
  font-weight: 600;
  text-align: center;
}

/* CTA centered with fixed width like the mock */
.stl-btn{
  display: inline-block;
  min-width: 220px;
  padding: 12px 20px;
  text-align: center;
  border: 1px solid black;
  color: black;
  text-decoration: none;
  border-radius: 3px;
}

/* Pin dots (pagination below card) centered and spaced */
.stl-pin-dots{
  justify-content: center;
  gap: 10px;
  margin-top: 8px;
}
.stl-pin-dot{
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: rgba(0,0,0,.35);
}
.stl-pin-dot.is-active{ background: rgba(0,0,0,.9); }

/* Arrow buttons offset to page edges a bit more (optional) */
@media (min-width: 1200px){
  slider-component .slider-button--prev{ margin-left: 32px; }
  slider-component .slider-button--next{ margin-right: 32px; }
}

/* ====== RESPONSIVE ====== */
@media (max-width: 989px){
  .stl-grid{
    grid-template-columns: 1fr;       /* stack on mobile */
    column-gap: 0;
    row-gap: 24px;
  }
  .stl-media,
  .stl-panel__inner{ max-width: none; width: 100%; }
  .stl-card__image{ width: min(92vw, 520px); }
}

.stl-heading {
  text-align: center;
  margin-bottom: 32px;}
  </style>

  <script>
    (() => {
      const track  = document.getElementById('STL-Track-{{ section.id }}');
      if(!track) return;
      const slides = Array.from(track.querySelectorAll('.stl-slide'));
      const prev   = track.closest('slider-component')?.querySelector('.slider-button--prev');
      const next   = track.closest('slider-component')?.querySelector('.slider-button--next');
      const modal  = document.getElementById('stl-modal-{{ section.id }}');
      const modalContent = modal?.querySelector('.stl-modal__content');

      // ---- slider arrows (track scroll, no page jump)
      let lookIndex = 0;
      function goTo(i){
        lookIndex = (i + slides.length) % slides.length;
        track.scrollTo({ left: slides[lookIndex].offsetLeft, behavior:'smooth' });
      }
      prev && prev.addEventListener('click', () => goTo(lookIndex - 1));
      next && next.addEventListener('click', () => goTo(lookIndex + 1));
      let sDeb;
      track.addEventListener('scroll', () => {
        clearTimeout(sDeb);
        sDeb = setTimeout(() => {
          const left = track.scrollLeft;
          let nearest = 0, min = Infinity;
          slides.forEach((s, i) => {
            const d = Math.abs(s.offsetLeft - left);
            if (d < min){ min = d; nearest = i; }
          });
          lookIndex = nearest;
        }, 80);
      }, { passive:true });

      // ---- pins behavior
      function activatePin(pin){
        const slide = pin.closest('.stl-slide');
        const look  = slide.dataset.look;
        const targetTpl = document.getElementById(`tpl-${pin.dataset.pinId?.replace('pin-','')}`) || document.getElementById(`tpl-${pin.dataset.pinId}`);
        const panel = slide.querySelector('.stl-panel [data-panel-for]');
        const dots  = slide.querySelectorAll('.stl-pin-dot');
        dots.forEach(d => d.classList.toggle('is-active', d.dataset.pinLinked === pin.dataset.pinId));

     if (window.matchMedia('(max-width: 989px)').matches){
  if (targetTpl) openModal(targetTpl.innerHTML);
  return;
}


        // Desktop: swap panel
        if (panel && targetTpl){
          panel.innerHTML = targetTpl.innerHTML;
        }
      }

      // Pin click
      track.addEventListener('click', (e) => {
        const pin = e.target.closest('.stl-pin');
        if(!pin) return;
        // Normalize id reference for dots
        pin.dataset.pinId = pin.dataset.pinId || ('pin-' + pin.getAttribute('data-pin-id'));
        activatePin(pin);
      });

      // Dots below card (desktop) click
      track.addEventListener('click', (e) => {
        const dot = e.target.closest('.stl-pin-dot');
        if(!dot) return;
        const slide = e.target.closest('.stl-slide');
        const pinId = dot.dataset.pinLinked;
        const pin = slide?.querySelector(`.stl-pin[data-pin-id="${pinId}"]`);
        if(pin) activatePin(pin);
      });

 // ---- Mobile Modal control ----
function openModal(html){
  if(!modal) return;
  modal.removeAttribute('hidden');
  modal.classList.add('is-active');
  document.body.style.overflow = 'hidden';
  modalContent.innerHTML = html;
}

function closeModal(){
  if(!modal) return;
  modal.classList.remove('is-active');
  setTimeout(() => {
    modal.setAttribute('hidden','');
    document.body.style.overflow = '';
    modalContent.innerHTML = '';
  }, 300);
}

modal?.addEventListener('click', (e) => {
  if (e.target.hasAttribute('data-close') || e.target.closest('[data-close]')){
    closeModal();
  }
});


      // Drag on desktop (mouse) for touch-like feel
      let isDown=false, startX=0, startScroll=0;
      const getX = (ev)=> (ev.touches && ev.touches[0]) ? ev.touches[0].clientX : ev.clientX;
      const onDown = (ev)=>{ isDown=true; startX=getX(ev); startScroll=track.scrollLeft; track.classList.add('is-dragging'); };
      const onMove = (ev)=>{ if(!isDown) return; track.scrollLeft = startScroll - (getX(ev)-startX); };
      const onUp   = ()=>{ isDown=false; track.classList.remove('is-dragging'); };
      track.addEventListener('mousedown', onDown); window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
      track.addEventListener('touchstart', onDown, {passive:true}); track.addEventListener('touchmove', onMove, {passive:true}); track.addEventListener('touchend', onUp, {passive:true});
    })();
  </script>
</section>

{% schema %}
{
  "name": "Shop the Look",
 "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Shop The Look" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "Discover curated looks and shop your favorite styles." },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "scheme-1" },
    { "type": "checkbox", "id": "full_width", "label": "Full width", "default": false }
  ],

  "blocks": [
    {
      "type": "look",
      "name": "Look (slide)",
      "settings": [
        { "type": "image_picker", "id": "desktop_image", "label": "Desktop image" },
        { "type": "image_picker", "id": "mobile_image", "label": "Mobile image (optional)" },
        { "type": "text", "id": "alt_text", "label": "Image alt text" }
      ]
    },
    {
      "type": "pin",
      "name": "Hotspot (product)",
      "settings": [
        { "type": "range", "id": "look_ref", "min": 1, "max": 50, "step": 1, "label": "Belongs to look #", "default": 1, "info": "Slide number this pin should appear on." },
        { "type": "product", "id": "product", "label": "Product" },
        { "type": "range", "id": "pos_x", "min": 0, "max": 100, "step": 1, "label": "Left position (%)", "default": 50 },
        { "type": "range", "id": "pos_y", "min": 0, "max": 100, "step": 1, "label": "Top position (%)", "default": 50 }
      ]
    }
  ],
  "presets": [
    { "name": "Shop the Look", "blocks": [ { "type": "look" }, { "type": "pin" }, { "type": "pin" } ] }
  ]
}
{% endschema %}
